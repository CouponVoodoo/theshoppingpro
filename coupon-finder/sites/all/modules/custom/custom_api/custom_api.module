<?php

function custom_api_menu() {
  $items = array();

  $items['add-product/%'] = array(//this creates a URL that will call this form at "examples/form-example"
      'title' => 'Add Product in database', //page title
      'page callback' => 'custom_api_addproduct', //this is the function that will be called when the page is accessed.  for a form, use drupal_get_form
      'page arguments' => array(1),
      'access callback' => TRUE
  );

  return $items;
}




function custom_api_addproduct($ProInfo){
	

     // print_r($_REQUEST['url']);
    
     // die;
    //$baseUrl = base64_decode( ($ProInfo) );
    $baseUrl = $_REQUEST['url'];
    if($_REQUEST['recheck'] == 1){	  
	  $Pageurl = "http://54.243.150.171/CouponAutoWebPhase2.php?q=" .  $baseUrl ;
      $url = "http://54.243.150.171/CouponAutoWebPhase2Recheck.php?q=" . urldecode( $baseUrl );
      //http://54.243.150.171/CouponAutoWebPhase2Recheck.php?q=http://www.firstcry.com/zeme-organics/maternity-top-orange/61968/product-detail
      $node_url = $base_url.drupal_get_path_alias('node/'.$_REQUEST['id']);
    }else{
      $Pageurl = "http://54.243.150.171/nodeCreation.php";    
      $url = "http://54.243.150.171/nodeCreation.php";
      
    }
	// mail('ashishgupta97065@gmail.com', 'URL', print_r($url));
	// mail('ashishgupta97065@gmail.com', 'URL', print_r($url));
    $json = drupal_http_request($url, array('timeout' => 600.0));
    if ( $json == 'done') {echo "done"; exit;}
    
	/** ASHISH NODE CREATION TIMING  - DATA REVEIVED
		$time1 = round(microtime(true)* 1000);
	echo nl2br("\n");
		echo 'Data Received: '.$time1;
	echo nl2br("\n");
	 -----------------------------------------   */
	
	
	
	$json = $json->data;
   
    
    $jsonArr = json_decode($json,true);
     foreach($jsonArr as $json){
    
	
	
	$json = json_encode($json); 
    $jsonData = preg_replace("/[\\n\\r]+/", " ", $json);
    $jsonArray = json_decode($jsonData);
 //   echo $jsonArray->header->BaseUrl. "</br>";
    
    
    /**added by sanjay*/
    //if($jsonArray->header->Use == 1 || $jsonArray->header->Use == 0){
    if($jsonArray->header->Use == 1){
      //$proTitle = $jsonArray->header->ProductName;
      $proTitle = $jsonArray->header->PageTitle;
      
      $baseUrl = $jsonArray->header->BaseUrl;
      
      $query = db_select('field_data_field_base_url', 'n')
		   ->fields('n', array('ntity_id') )
		   ->condition('n.field_base_url_value', $baseUrl, '=')
		   ->countQuery();
      $result = $query->execute();
      $record = $result->fetch();
      
	  	/** ASHISH NODE CREATION TIMING  - NODE FETCHED
		$time1 = round(microtime(true)* 1000);
		echo 'Node Fetched: '.$time1;
	echo nl2br("\n");
		 -----------------------------------------   */

	  
	  
      
      $brand_name = $jsonArray->header->ProductBrand;
	 // $Query = db_query("SELECT tid FROM taxonomy_term_data WHERE vid = 4 and name = '$brand_name' ");
	  $Query=db_query('SELECT ttd.tid FROM {taxonomy_term_data} AS ttd WHERE ttd.vid = 4 and ttd.name = :brand_name', array(':brand_name' => $brand_name));
	  $Ruery = $Query->fetch();
	  $BrandId = $Ruery->tid;

	  /** ASHISH NODE CREATION TIMING  - BRAND CHECKED
		$time1 = round(microtime(true)* 1000);
		echo 'Brand CHecked: '.$time1;
	echo nl2br("\n");
		 -----------------------------------------   */
	  
      //$brand_name = 'nike';
      // $vocabulary_name = 'brand';
      // $BrandId = coupons_get_term_from_name($brand_name, $vocabulary_name);
      
	  //echo '===='.$brand_name;
      if($BrandId == ''){
	$BrandId = coupons_create_taxonomy_term($brand_name, 4);
      }

	  	/** ASHISH NODE CREATION TIMING  - Brand Created
		$time1 = round(microtime(true)* 1000);
		echo 'Brand Created: '.$time1;
	echo nl2br("\n");
		 -----------------------------------------   */
      

      if($record->expression == 0){
	//echo 'add';
	//die;
	$node = new stdClass();
	$node->language = LANGUAGE_NONE;
	$node->type     = '_product_and_coupon';	
	$node->uid      = 1;
    
	$node->field_category['und'][0]['tid']			= trim( $jsonArray->header->Category );
	$node->field_category['und'][0]['tid']			= trim( $jsonArray->header->Category );
	//$node->field_category['und'][0]['tid']			= 1;
	
	$node->title    				  	= $proTitle;
	$node->field_description['und']['0'][value]	 	  	= trim( $jsonArray->header->ProductDescription );
	$node->field_product_price['und']['0'][value]	  	= ( $jsonArray->header->ListingProductPrice )?$jsonArray->header->ListingProductPrice:0;
	//$node->field_product_price['und']['0'][value]	  	= 10;
	//$node->field_retailer['und']['0']['tid'] 		  	= ($jsonArray->header->Retailer > 0)?$jsonArray->header->Retailer:1;
	$node->field_retailer['und']['0']['tid'] 		  	= $jsonArray->header->Retailer;
	//$node->field_retailer['und']['0']['tid'] 		  	= 1;
	$node->field_base_url['und']['0'][value] 		  	= trim( $jsonArray->header->BaseUrl);
	$node->field_retailer_product_name['und']['0'][value] 	= trim( $jsonArray->header->ProductName );
	$node->field_product_image['und']['0'][value] 	  	= trim( $jsonArray->header->ProductImage );
	$node->field_brand['und']['0']['tid'] 		  	= trim($jsonArray->header->ProductBrand);
	$node->field_brand['und']['0']['tid'] 		  	= $BrandId;
	
	$node->field_mrpproductprice['und']['0'][value]	  	= ($jsonArray->header->MRPProductPrice!='')?$jsonArray->header->MRPProductPrice:0 ;
	//$node->field_mrpproductprice['und']['0'][value]	  	= 0 ;
	$expDate = explode('=' , $jsonArray->header->LastCheckedTime);	
	$node->field_lastcheckedtime['und']['0'][value]	  	= $expDate[0];
	$node->field_affiliateurl['und']['0'][value]	  	= trim( $jsonArray->header->AffiliateURL );
	$node->body['und']['0'][value]			  	= trim( $jsonArray->header->MetaDescription );
	///$node->metatag['und']['0']['data']			= trim( $jsonArray->header->MetaDescription );
	$node->field_best_coupon_description['und']['0'][value]	= trim( $jsonArray->header->bestCouponResult->CouponDesc );
	
	$node->field_best_coupon_status['und']['0'][value]	  	= trim( $jsonArray->header->CouponResult );
	
	if ($node->field_best_coupon_status['und']['0'][value] == 1) {
		$node->field_best_coupon_status_display['und']['0'][value] = 'With Coupons';
	} else {
		$node->field_best_coupon_status_display['und']['0'][value] = 'Without Coupons';
	}
	//$node->field_product_popularity['und']['0'][value]	= ( $jsonArray->header->Popularity )?$jsonArray->header->Popularity:0;
	$node->field_product_popularity['und']['0'][value]	  	= $jsonArray->header->Popularity;
	
	///if($jsonArray->header->CouponResult == 1){
	  $node->field_best_coupon_couponcode['und']['0'][value] 	= trim( $jsonArray->header->bestCouponResult->CouponCode );
	  $node->field_best_coupon_saving['und']['0'][value]	= ( $jsonArray->header->bestCouponResult->Saving)?$jsonArray->header->bestCouponResult->Saving:0;
	  $node->field_best_coupon_netpriceafters['und']['0'][value]= ( $jsonArray->header->bestCouponResult->NetPriceAfterSaving)?$jsonArray->header->bestCouponResult->NetPriceAfterSaving:0;
	  $node->field_best_coupon_url['und']['0'][value]		= trim( $jsonArray->header->bestCouponResult->url );
	//}
	//mail('sanjay.kumar1@mail.vinove.com','jsonArray','jsonArray--->'.print_r($jsonArray->data,1));
	$node->field_best_coupon_info['und']['0'][value]		= serialize( $jsonArray->data );
	
	//$node->	field_page_url['und']['0'][value]		= $Pageurl;
	
	/*$ImgPath = $jsonArray->header->ProductImage;
	$ImgFile = pathinfo($ImgPath);         // $file is set to "index.php"
	
	$image = file_get_contents($ImgPath); // string
	$file = file_save_data($image, 'public://'.$ImgFile['basename'] ,FILE_EXISTS_REPLACE);
	$node->field_product_images[LANGUAGE_NONE]['0']['fid'] = $file->fid;*/
	
	node_save($node);
	global $base_url;
	
	/*$urlAlias = $base_url.'/'.drupal_get_path_alias('node/'.$node->nid);
	
	$node2 = node_load( $node->nid );
	$node2->field_page_url['und']['0'][value] = $urlAlias;
	node_save($node2);
	*/
	if( !empty($node->nid) ){
	  $response = json_encode( array('ResponseCode' => '1', 'Response' => 'Node added.', 'URL' => $url, 'BASEURL' => $jsonArray->header->BaseUrl) );
	  echo $response;
	}else{
	  $response = json_encode( array('ResponseCode' => '4', 'Response' => 'Unexpected Error.') );
	  echo $response;
	}
	
      }elseif($record->expression == 1){
	 echo 'update';
	
		/** ASHISH NODE CREATION TIMING  - UPDATE LOOP ENTERED
		$time1 = round(microtime(true)* 1000);
		echo 'Update Loop Entered: '.$time1;
	echo nl2br("\n");
		 -----------------------------------------   */

	
	$expDate = explode('=' , $jsonArray->header->LastCheckedTime);

	//check product exist or not
	$query = db_select('field_data_field_base_url', 'n')
		     ->fields('n', array('entity_id','field_base_url_value') )
		     ->condition('n.field_base_url_value', $baseUrl, '=');		   
	$result = $query->execute();
	$record = $result->fetch();

	$queryLastUpdate = db_select('field_data_field_lastcheckedtime', 'n')
		     ->fields('n', array('field_lastcheckedtime_value') )
		     ->condition('n.entity_id ', $record->entity_id , '=');		   
	$resultLastUpdate = $queryLastUpdate->execute();
	$recordLastUpdate = $resultLastUpdate->fetch();
	
	$lastUpdatedDate = $recordLastUpdate->field_lastcheckedtime_value;
	global $base_url;
	  
	$urlAlias = $base_url.'/'.drupal_get_path_alias('node/'.$record->entity_id);
	
	if( $expDate[0] != $lastUpdatedDate){
	  echo 'date loop';
  	  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'Last Update Time Loop: '.$time1;
	echo nl2br("\n");
		 -----------------------------------------   */

	  
	  
/** BY ASHISH REMOVING DUPLICATE THIS IS ALREADY HAPPENING IN THE MAIN LOOP
	  $brand_name = $jsonArray->header->ProductBrand;
	  //$brand_name = 'nike';
	  $vocabulary_name = 'brand';
	  $BrandId = coupons_get_term_from_name($brand_name, $vocabulary_name);
	  if($BrandId == 0){
	    $BrandId = coupons_create_taxonomy_term($brand_name, 4);
	  }
*/	  
	  
	  $node = node_load($record->entity_id);

  	  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'Node Loaded: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */


	  if($_REQUEST['recheck'] != 1){
		
		// BY ASHISH - NOT USING NODESAVE $node->field_category['und'][0]['tid']			= trim( $jsonArray->header->Category );
		// db_query("UPDATE {field_data_field_category} SET field_category_tid = :categoryid WHERE revision_id = :vid", array(':categoryid' => trim( $jsonArray->header->Category ), ':vid' => $node->vid));
		// db_query("UPDATE {field_revision_field_category} SET field_category_tid = :categoryid WHERE revision_id = :vid", array(':categoryid' => trim( $jsonArray->header->Category ), ':vid' => $node->vid));
	
	} 

		// BY ASHISH - NOT USING NODESAVE  $node->title    				  	= $proTitle;
		
		$changed = time();
		

		db_query("UPDATE {node} SET title = :title, changed = :changed WHERE nid = :nid", array(':title' => $proTitle, ':changed' => $changed, ':nid' => $node->nid));

  	  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'Node Table Update: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

		db_query("UPDATE {node_revision} SET title = :title, timestamp = :changed WHERE vid = :vid", array(':title' => $proTitle, ':changed' => $changed, ':vid' => $node->vid));
  	  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'Revision Table Updated: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */
	  
	  
		// BY ASHISH - NOT USING NODESAVE $node->field_description['und']['0'][value]	 	= trim( $jsonArray->header->ProductDescription );
		$node->field_product_price['und']['0'][value]	  	= ( $jsonArray->header->ListingProductPrice )?$jsonArray->header->ListingProductPrice:0;
		db_query("UPDATE {field_data_field_product_price} SET field_product_price_value = :product_price WHERE revision_id = :vid", array(':product_price' => $node->field_product_price['und']['0'][value], ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_product_price} SET field_product_price_value = :product_price WHERE revision_id = :vid", array(':product_price' => $node->field_product_price['und']['0'][value], ':vid' => $node->vid));
		
			  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'PRICE: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

		
		// BY ASHISH - NOT USING NODESAVE $node->field_retailer['und']['0']['tid'] 		  	= $jsonArray->header->Retailer;
		// BY ASHISH - NOT USING NODESAVE $node->field_base_url['und']['0'][value] 		  	= trim( $jsonArray->header->BaseUrl);
		// BY ASHISH - NOT USING NODESAVE $node->field_retailer_product_name['und']['0'][value] 	= trim( $jsonArray->header->ProductName );
		// BY ASHISH - NOT USING NODESAVE $node->field_product_image['und']['0'][value] 	  	= trim( $jsonArray->header->ProductImage );
		// BY ASHISH - NOT USING NODESAVE $node->field_brand['und']['0']['tid'] 		  	= trim($jsonArray->header->ProductBrand);
		// BY ASHISH - NOT USING NODESAVE $node->field_brand['und']['0']['tid'] 		  	= $BrandId;
	  
		$node->field_mrpproductprice['und']['0'][value]	  	= ($jsonArray->header->MRPProductPrice!='')?$jsonArray->header->MRPProductPrice:0 ;
		db_query("UPDATE {field_data_field_mrpproductprice} SET field_mrpproductprice_value = :mrpproductprice WHERE revision_id = :vid", array(':mrpproductprice' => $node->field_mrpproductprice['und']['0'][value], ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_mrpproductprice} SET field_mrpproductprice_value = :mrpproductprice WHERE revision_id = :vid", array(':mrpproductprice' => $node->field_mrpproductprice['und']['0'][value], ':vid' => $node->vid));
		
			  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'MRP: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

		
		// BY ASHISH - NOT USING NODESAVE $node->field_lastcheckedtime['und']['0'][value]	  	= $expDate[0];
		db_query("UPDATE {field_data_field_lastcheckedtime} SET field_lastcheckedtime_value = :lastcheckedtime WHERE revision_id = :vid", array(':lastcheckedtime' => $expDate[0], ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_lastcheckedtime} SET field_lastcheckedtime_value = :lastcheckedtime WHERE revision_id = :vid", array(':lastcheckedtime' => $expDate[0], ':vid' => $node->vid));
		
		/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'LAST CHECKED TIME: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

		
		// BY ASHISH - NOT USING NODESAVE $node->field_affiliateurl['und']['0'][value]	  	= trim( $jsonArray->header->AffiliateURL );
		// BY ASHISH - NOT USING NODESAVE $node->body['und']['0'][value]			  	= trim( $jsonArray->header->MetaDescription );
		// BY ASHISH - NOT USING NODESAVE $node->field_best_coupon_description['und']['0'][value]	= trim( $jsonArray->header->bestCouponResult->CouponDesc );
	  	db_query("UPDATE {field_data_field_best_coupon_description} SET field_best_coupon_description_value = :best_coupon_description WHERE revision_id = :vid", array(':best_coupon_description' => trim( $jsonArray->header->bestCouponResult->CouponDesc ), ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_best_coupon_description} SET field_best_coupon_description_value = :best_coupon_description WHERE revision_id = :vid", array(':best_coupon_description' => trim( $jsonArray->header->bestCouponResult->CouponDesc ), ':vid' => $node->vid));
	
	
		  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'COUPON DESCRIPTION: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

		
		// BY ASHISH - NOT USING NODESAVE $node->field_best_coupon_status['und']['0'][value]	= trim( $jsonArray->header->CouponResult );
		db_query("UPDATE {field_data_field_best_coupon_status} SET field_best_coupon_status_value = :field_best_coupon_status WHERE revision_id = :vid", array(':field_best_coupon_status' => trim( $jsonArray->header->CouponResult ), ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_best_coupon_status} SET field_best_coupon_status_value = :field_best_coupon_status WHERE revision_id = :vid", array(':field_best_coupon_status' => trim( $jsonArray->header->CouponResult ), ':vid' => $node->vid));
		$coupon_display = trim( $jsonArray->header->CouponResult );
		if ($coupon_display == 1) {
			$coupon_status_display = 'With Coupons';
		} else {
			$coupon_status_display = 'Without Coupons';
		}	
		
		db_merge('field_data_field_best_coupon_status_display')
				->key(array('revision_id' => $node->vid))
				->fields(array(
				'field_best_coupon_status_display_value' => $coupon_status_display,
				'entity_id'=> $record->entity_id,
				'delta'=> 0,
				'entity_type'=> 'node',
				'bundle'=> '_product_and_coupon',
				'language'=>'und',
			))
			->execute();
		
	
			  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'COUPON STATUS: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

		
		// BY ASHISH - NOT USING NODESAVE $node->field_product_popularity['und']['0'][value]	= $jsonArray->header->Popularity;
	    // BY ASHISH - NOT USING NODESAVE $node->field_best_coupon_couponcode['und']['0'][value] 	= trim( $jsonArray->header->bestCouponResult->CouponCode );
	    db_query("UPDATE {field_data_field_best_coupon_couponcode} SET field_best_coupon_couponcode_value = :field_best_coupon_couponcode WHERE revision_id = :vid", array(':field_best_coupon_couponcode' => trim( $jsonArray->header->bestCouponResult->CouponCode ), ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_best_coupon_couponcode} SET field_best_coupon_couponcode_value = :field_best_coupon_couponcode WHERE revision_id = :vid", array(':field_best_coupon_couponcode' => trim( $jsonArray->header->bestCouponResult->CouponCode ), ':vid' => $node->vid));
	
		  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'COUPON CODE: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

	
	
		$node->field_best_coupon_saving['und']['0'][value]	= ( $jsonArray->header->bestCouponResult->Saving)?$jsonArray->header->bestCouponResult->Saving:0;
	    db_query("UPDATE {field_data_field_best_coupon_saving} SET field_best_coupon_saving_value = :field_best_coupon_saving WHERE revision_id = :vid", array(':field_best_coupon_saving' => $node->field_best_coupon_saving['und']['0'][value], ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_best_coupon_saving} SET field_best_coupon_saving_value = :field_best_coupon_saving WHERE revision_id = :vid", array(':field_best_coupon_saving' => $node->field_best_coupon_saving['und']['0'][value], ':vid' => $node->vid));

		/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'COUPON SAVING: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

		$node->field_best_coupon_netpriceafters['und']['0'][value]= ( $jsonArray->header->bestCouponResult->NetPriceAfterSaving)?$jsonArray->header->bestCouponResult->NetPriceAfterSaving:0;
	    db_query("UPDATE {field_data_field_best_coupon_netpriceafters} SET field_best_coupon_netpriceafters_value = :field_best_coupon_netpriceafters WHERE revision_id = :vid", array(':field_best_coupon_netpriceafters' => $node->field_best_coupon_netpriceafters['und']['0'][value], ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_best_coupon_netpriceafters} SET field_best_coupon_netpriceafters_value = :field_best_coupon_netpriceafters WHERE revision_id = :vid", array(':field_best_coupon_netpriceafters' => $node->field_best_coupon_netpriceafters['und']['0'][value], ':vid' => $node->vid));

	  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'NETRICE: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */
	
		// BY ASHISH - NOT USING NODESAVE $node->field_best_coupon_url['und']['0'][value]		= trim( $jsonArray->header->bestCouponResult->url );
		db_query("UPDATE {field_data_field_best_coupon_url} SET field_best_coupon_url_value = :best_coupon_url WHERE revision_id = :vid", array(':best_coupon_url' => trim( $jsonArray->header->bestCouponResult->url ), ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_best_coupon_url} SET field_best_coupon_url_value = :best_coupon_url WHERE revision_id = :vid", array(':best_coupon_url' => trim( $jsonArray->header->bestCouponResult->url ), ':vid' => $node->vid));
	
	  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'BEST COUPON URL : '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */
	
		
		// BY ASHISH - NOT USING NODESAVE $node->field_best_coupon_info['und']['0'][value]		= serialize( $jsonArray->data );
		db_query("UPDATE {field_data_field_best_coupon_info} SET field_best_coupon_info_value = :best_coupon_info WHERE revision_id = :vid", array(':best_coupon_info' => serialize( $jsonArray->data ), ':vid' => $node->vid));
		db_query("UPDATE {field_revision_field_best_coupon_info} SET field_best_coupon_info_value = :best_coupon_info WHERE revision_id = :vid", array(':best_coupon_info' => serialize( $jsonArray->data ), ':vid' => $node->vid));
	
	  	/** ASHISH NODE CREATION TIMING  - LAST UPDATE URL
		$time1 = round(microtime(true)* 1000);
		echo 'All Coupon Info Update: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */
	
		apachesolr_mark_entity ('node', $node->nid);
	 
	 
 	  	/** ASHISH NODE CREATION TIMING  - Node Data
		$time1 = round(microtime(true)* 1000);
		echo 'Mareked for SOLR: '.$time1;
		echo nl2br("\n");
		 -----------------------------------------   */

	  
		// BY ASHISH - NOT USING NODESAVE node_save($node);
	  
	  
	  if( !empty($node->nid) ){
	    $response = json_encode( array('ResponseCode' => '2', 'Response' => 'Node Updated.', 'URL' => $url, 'BASEURL' => $jsonArray->header->BaseUrl) );

		/** NEED TO UNCOMMENT THE LINE BELOW */
			    echo $response;
				
	if($_REQUEST['recheck'] == 1){
		   mail('ashishgupta97065@gmail.com', 'recheck loop: ', print_r($node_url));
		  $cache_url = url('node/'. $nid);
		  echo 'node id: '.$node->nid.' url : '.$node_url.' cache url: '.$cache_url;
		  die;
		  // $options = array('absolute' => TRUE);
			
			 //drupal_flush_all_caches();
			// entity_get_controller('node')->resetCache(array($node->nid));
		   // drupal_goto($node_url);
    }
				
				
				
	  }else{
	    $response = json_encode( array('ResponseCode' => '4', 'Response' => 'Unexpected Error.') );
	    echo $response;
	  }

 	  	/** ASHISH NODE CREATION TIMING  - End Process*/
		$time1 = round(microtime(true)* 1000);
		echo 'End Process: '.$time1;
	echo nl2br("\n");
		echo nl2br("\n");
			echo '___________________________________________'    ;
		/** -----------------------------------------   */

	  
	}else{
	    $response = json_encode( array('ResponseCode' => '3', 'Response' => 'Node Ignored - Node Already Updated.', 'NodeId' => $jsonArray->header->BaseUrl) );
	    echo $response;	    
	}
      }	
    } 
    /*end here*/   
     




	 
   /* if($_REQUEST['recheck'] == 1){
		  mail('ashishgupta97065@gmail.com', 'node_url', 'node_url');
		  $options = array('absolute' => TRUE);
			$url = url('node/' . $nid, $options);
	  	   drupal_goto($node_url);
    }*/}   
} 

/** START OF BY ASHISH TO MODIFY SEARCH RESULTS BY BOOSTING ON COUPON STATUS AND LAST CHECKED, HIDE WHERE LAST CHECKED IS GREATER THAN THRESHHOLD*/
function custom_api_apachesolr_query_prepare(DrupalSolrQueryInterface $query) {
   $current_time= time()+(5.5*3600);
   $boost_time=$current_time-(26*3600);
   $hide_time=$current_time-(36*3600);
   $solr_boost_time=gmdate('Y-m-d\TH:i:s\Z', $boost_time);
   $solr_hide_time=gmdate('Y-m-d\TH:i:s\Z', $hide_time);
   $solr_time_coupon_boost= "'(itm_field_best_coupon_status:1 AND dm_field_lastcheckedtime:[".$solr_boost_time." TO *])^5'";
   $solr_hide_time_coupon="dm_field_lastcheckedtime:[".$solr_hide_time." TO *]";
//   echo $solr_hide_time_coupon;
   $query->addParam('fq', $solr_hide_time_coupon);
//   $query->addParam('fq', '-(sm_vid_Retailer:Flipkart.com)');
   $query->addParam('bq', $solr_time_coupon_boost);

/** START OF BY ASHISH TO RANDOMIZE RESULTS FOR ALL EXCEPT RETAILER*/
	$termid = arg(2);
	$term = taxonomy_term_load($termid);
	$vid = $term->vid;
	$seed = rand(1, 1000);
	if ($vid == 3 OR $vid == 4){
		$query->addParam('sort', 'random_'.$seed.' asc');
	} 
/** END OF BY ASHISH TO RANDOMIZE RESULTS FOR ALL EXCEPT RETAILER*/
}
/** END OF BY ASHISH TO MODIFY SEARCH RESULTS BY BOOSTING ON COUPON STATUS AND UPDATE */



?>
